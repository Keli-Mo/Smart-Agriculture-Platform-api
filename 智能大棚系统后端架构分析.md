# 智能大棚环境监测系统后端架构分析报告

## 一、项目整体架构

这是一个基于Spring Boot 2.7.15的多模块Maven项目，采用分层架构设计，专门针对智能农业环境监测场景开发。

### 模块结构：
- **neu-admin**: 主应用模块（端口5502）- 控制器和Web层
- **neu-framework**: 核心框架模块 - 工具类、安全配置、数据源配置
- **neu-system**: 系统管理模块 - 用户、角色、菜单等基础功能
- **neu-lx**: 农业业务模块 - 设备管理、AI聊天、环境监测等核心业务
- **neu-common**: 公共模块 - 共享工具类和常量
- **neu-quartz**: 定时任务模块
- **neu-generator**: 代码生成模块

### 技术栈：
- **Spring Boot 2.7.15**: 主框架
- **MyBatis 2.3.1**: ORM框架
- **Druid 1.2.18**: 数据库连接池
- **MySQL 8.0.32**: 数据库
- **Ollama4j 1.0.93**: AI集成
- **Redis**: 缓存（端口63821，数据库6）

---

## 二、MySQL数据管理核心实现

### 2.1 数据库配置

数据库连接配置位于 `neu-admin/src/main/resources/application-druid.yml`：

```yaml
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    druid:
      master:
        url: jdbc:mysql://127.0.0.1:3306/air?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
        username: root
        password: 820123
```

**Druid连接池优势：**
- 初始连接数：15
- 最小连接池：20
- 最大连接池：50
- 支持慢SQL记录（超过1000ms）
- 内置监控界面：http://localhost:5502/druid/

### 2.2 核心农业数据表设计

#### 2.2.1 聊天记录表（acw_chat_messages）
```sql
CREATE TABLE `acw_chat_messages` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id` bigint(20) DEFAULT NULL COMMENT '用户ID',
  `role` varchar(10) DEFAULT NULL COMMENT '角色(user/assistant)',
  `content` text COMMENT '消息内容',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=51 DEFAULT CHARSET=utf8mb4 COMMENT='聊天记录';
```

**设计特点：**
- 支持utf8mb4字符集，可存储emoji表情
- 自动时间戳，便于历史记录追踪
- 角色字段区分用户和AI助手

#### 2.2.2 设备信息表（acw_device_info）
```sql
CREATE TABLE `acw_device_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `serial_no` varchar(100) DEFAULT NULL COMMENT '设备编号',
  `device_type` varchar(50) DEFAULT NULL COMMENT '设备类型',
  `status` varchar(20) DEFAULT NULL COMMENT '设备状态',
  `register_date` date DEFAULT NULL COMMENT '注册日期',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8mb4 COMMENT='设备信息';
```

#### 2.2.3 大棚监测数据表（acw_greenhouse_monitor）
```sql
CREATE TABLE `acw_greenhouse_monitor` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `gh_id` bigint(20) DEFAULT NULL COMMENT '大棚',
  `device_no` varchar(100) DEFAULT NULL COMMENT '设备编号',
  `temperature` varchar(20) DEFAULT NULL COMMENT '温度',
  `humility` varchar(20) DEFAULT NULL COMMENT '湿度',
  `smoke` varchar(20) DEFAULT NULL COMMENT '烟雾',
  `pm25` varchar(20) DEFAULT NULL COMMENT 'PM2.5',
  `data_time` datetime DEFAULT NULL COMMENT '监测时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='大棚监测';
```

#### 2.2.4 预警记录表（acw_alert_log）
```sql
CREATE TABLE `acw_alert_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `gh_id` bigint DEFAULT NULL COMMENT '大棚id',
  `device_no` varchar(50) DEFAULT NULL COMMENT '设备编码',
  `temperature` varchar(10) DEFAULT NULL COMMENT '温度',
  `humility` varchar(10) DEFAULT NULL COMMENT '湿度',
  `smoke` varchar(10) DEFAULT NULL COMMENT '烟雾',
  `pm25` varchar(10) DEFAULT NULL COMMENT 'PM2.5',
  `alert` varchar(500) DEFAULT NULL COMMENT '预警信息',
  `type` varchar(50) DEFAULT NULL COMMENT '预警类型',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `create_by` varchar(64) DEFAULT NULL COMMENT '创建者',
  PRIMARY KEY (`id`),
  KEY `idx_gh_id` (`gh_id`),
  KEY `idx_device_no` (`device_no`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预警记录表';
```

**索引优化策略：**
- `idx_gh_id`: 大棚ID索引，快速查询特定大棚记录
- `idx_device_no`: 设备编号索引，设备相关查询优化
- `idx_create_time`: 时间索引，支持时间范围查询

### 2.3 数据访问层实现

#### 2.3.1 实体类映射
以聊天记录实体为例（`neu-lx/src/main/java/com/neu/system/domain/AcwChatMessages.java`）：

```java
@Schema(description = "聊天记录对象", title = "com.neu.system.domain.AcwChatMessages")
public class AcwChatMessages extends BaseEntity {
    private static final long serialVersionUID = 1L;

    /** 主键 */
    private Long id;
    /** 用户ID */
    @Excel(name = "用户ID")
    private Long userId;
    /** 角色(user/assistant) */
    @Excel(name = "角色(user/assistant)")
    private String role;
    /** 消息内容 */
    @Excel(name = "消息内容")
    private String content;
}
```

#### 2.3.2 MyBatis Mapper配置
以聊天记录Mapper为例（`neu-lx/src/main/resources/mapper/system/AcwChatMessagesMapper.xml`）：

```xml
<select id="selectAcwChatMessagesList" parameterType="AcwChatMessages" resultMap="AcwChatMessagesResult">
    select id, user_id, role, content, create_time from acw_chat_messages
    <where>
        <if test="userId != null "> and user_id = #{userId}</if>
        <if test="role != null  and role != ''"> and role = #{role}</if>
        <if test="params.beginCreateTime != null and params.beginCreateTime != '' and params.endCreateTime != null and params.endCreateTime != ''">
            and create_time between #{params.beginCreateTime} and #{params.endCreateTime}
        </if>
    </where>
</select>
```

**动态SQL优势：**
- 支持多条件组合查询
- 避免SQL注入风险
- 灵活的参数传递机制

#### 2.3.3 业务逻辑层实现
服务层实现（`neu-lx/src/main/java/com/neu/system/service/impl/AcwChatMessagesServiceImpl.java`）：

```java
@Override
public int insertAcwChatMessages(AcwChatMessages acwChatMessages) {
    acwChatMessages.setCreateTime(DateUtils.getNowDate());
    return acwChatMessagesMapper.insertAcwChatMessages(acwChatMessages);
}
```

---

## 三、Ollama AI集成与聊天记录管理

### 3.1 Ollama配置管理

配置文件（`neu-lx/src/main/java/com/neu/system/ai/config/OllamaConfig.java`）：

```java
@Configuration
public class OllamaConfig {
    @Value("${ollama.url}")
    private String ollamaUrl;

    @Value("${ollama.model-name:deepseek-r1:1.5b}")
    private String modelName;

    @Bean
    OllamaAPI getOllamaAPI() {
        OllamaAPI ollamaAPI = new OllamaAPI(ollamaUrl);
        ollamaAPI.setVerbose(false);
        ollamaAPI.setRequestTimeoutSeconds(ollamaRequestTimeoutSeconds);
        return ollamaAPI;
    }
}
```

**配置参数：**
- 服务地址：通过环境变量`OLLAMA_HOST_ADDR`配置，默认`http://localhost:11434`
- 模型名称：deepseek-r1:8b（支持8B参数的大模型）
- 请求超时：300秒，适应长文本生成需求

### 3.2 AI聊天核心服务

主要实现（`neu-lx/src/main/java/com/neu/system/ai/AgricultureAIService.java`）：

```java
public SseEmitter createChatStream(Long userId, String question) {
    log.info("创建AI会话，用户：{}，问题：{}", userId, question);
    SseEmitter emitter = new SseEmitter(300000L);
    new Thread(() -> {
        try {
            // 获取历史记录
            List<OllamaChatMessage> context = getContext(userId);

            OllamaChatRequestBuilder builder = OllamaChatRequestBuilder.getInstance(ollamaConfig.getModelName());
            builder.withMessage(OllamaChatMessageRole.SYSTEM, PromptUtils.buildConsultPrompt(context));
            if (!context.isEmpty()) {
                builder.withMessages(context);
            }
            builder.withMessage(OllamaChatMessageRole.USER, question);

            OllamaStreamHandler streamHandler = (s) -> {
                try {
                    // 处理AI响应流
                    emitter.send(s + "\n\n");
                } catch (IOException e) {
                    log.error("SSE发送失败", e);
                    emitter.completeWithError(e);
                }
            };
            ollama.chat(request, streamHandler);

            // 保存AI回复到数据库
            AcwChatMessages assistantMsg = new AcwChatMessages();
            assistantMsg.setUserId(userId);
            assistantMsg.setRole(OllamaChatMessageRole.ASSISTANT.getRoleName());
            assistantMsg.setContent(reply.get());
            chatMessagesService.insertAcwChatMessages(assistantMsg);

            emitter.send("<EOF>");
            emitter.complete();
        } catch (Exception ex) {
            emitter.completeWithError(ex);
        }
    }).start();

    return emitter;
}
```

**技术亮点：**
- **Server-Sent Events (SSE)**：实现服务器向客户端的实时推送
- **异步处理**：新线程处理AI请求，避免阻塞主线程
- **上下文管理**：获取用户最近5条历史记录，保持对话连贯性
- **错误处理**：完善的异常捕获和错误传播机制

### 3.3 聊天记录管理接口

RESTful API设计（`neu-lx/src/main/java/com/neu/system/controller/AcwChatMessagesController.java`）：

```java
@Tag(name = "聊天记录", description = "聊天记录")
@RestController
@RequestMapping("/system/chatMessages")
public class AcwChatMessagesController extends BaseController {

    @Operation(summary = "查询聊天记录列表")
    @GetMapping("/list")
    public TableDataInfo list(@Schema(hidden = true) AcwChatMessages acwChatMessages) {
        startPage();
        List<AcwChatMessages> list = acwChatMessagesService.selectAcwChatMessagesList(acwChatMessages);
        return getDataTable(list);
    }
}
```

**API特性：**
- **Swagger文档**：自动生成OpenAPI 3.0文档
- **分页查询**：支持PageHelper分页插件
- **条件过滤**：支持用户ID、角色、时间范围等多条件查询
- **数据导出**：支持Excel格式导出聊天记录

### 3.4 流式聊天接口

实时聊天接口（`neu-lx/src/main/java/com/neu/system/controller/AcwApiController.java`）：

```java
@GetMapping(path="/chat/stream",produces = "text/event-stream")
public SseEmitter createStreamChat(ChatMessageVO chatMessageVO) {
    try {
        return agricultureAIService.createChatStream(chatMessageVO.getUserId(), chatMessageVO.getQuestion());
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}
```

**接口特点：**
- **SSE协议**：支持服务器推送，实现真正的实时通信
- **长连接**：5分钟超时，适合长时间对话场景
- **MIME类型**：`text/event-stream`，符合SSE规范

---

## 四、核心配置文件详解

### 4.1 应用主配置

配置文件（`neu-admin/src/main/resources/application.yml`）：

```yaml
# ollama配置
ollama:
  # ollama服务的地址
  url: ${OLLAMA_HOST_ADDR:http://localhost:11434}
  # 请求超时时间，单位：秒
  request-timeout-seconds: 300
  # 模型名称
  model-name: deepseek-r1:8b

# 高德地图配置
gaode:
  # 高德地图API Key
  key: ${GAODE_API_KEY:7ef39f005121dc7410b1ffe900531b38}
```

### 4.2 Redis缓存配置

```yaml
spring:
  redis:
    host: 127.0.0.1
    port: 63821
    database: 6
    password:
    timeout: 10s
```

**Redis应用场景：**
- 用户会话管理
- 缓存热点数据
- 分布式锁支持

### 4.3 MyBatis配置

```yaml
# MyBatis配置
mybatis:
  # 搜索指定包别名
  typeAliasesPackage: com.neu.**.domain
  # 配置mapper的扫描，找到所有的mapper.xml映射文件
  mapperLocations: classpath*:mapper/**/*Mapper.xml
  # 加载全局的配置文件
  configLocation: classpath:mybatis/mybatis-config.xml
```

---

## 五、系统特色与技术优势

### 5.1 数据管理优势

#### ✅ Druid连接池优化
- **连接池监控**：实时监控连接使用情况
- **慢SQL检测**：自动记录执行超过1秒的SQL
- **SQL防火墙**：防止SQL注入攻击
- **性能统计**：详细的性能指标统计

#### ✅ MyBatis Plus增强
- **代码生成器**：自动生成实体类、Mapper、Service
- **分页插件**：物理分页，性能优异
- **条件构造器**：链式调用，避免手写SQL
- **性能分析**：开发环境SQL执行时间统计

#### ✅ 数据库设计优化
- **索引策略**：关键字段建立复合索引
- **字符集选择**：utf8mb4支持emoji和特殊字符
- **时间戳设计**：自动记录创建和修改时间
- **软删除支持**：逻辑删除，数据安全

### 5.2 AI集成特色

#### ✅ Ollama本地化部署
- **数据隐私**：所有AI处理在本地完成
- **模型灵活**：支持多种开源大模型
- **成本控制**：无需API调用费用
- **离线运行**：不依赖外部网络服务

#### ✅ 流式响应体验
- **实时推送**：SSE技术实现毫秒级响应
- **渐进式显示**：AI回答逐字显示，提升用户体验
- **断线重连**：自动处理网络中断情况
- **内存优化**：流式处理，避免大内存占用

#### ✅ 智能上下文管理
- **历史记录**：自动保存用户-AI对话历史
- **上下文窗口**：智能提取相关历史信息
- **角色识别**：区分用户、助手、系统消息
- **会话隔离**：不同用户会话完全隔离

### 5.3 业务功能亮点

#### ✅ 实时环境监测
- **多维度采集**：温度、湿度、烟雾、PM2.5全覆盖
- **设备状态监控**：在线状态、电量、信号强度
- **数据频率控制**：5分钟内重复数据智能过滤
- **异常检测**：AI驱动的环境异常识别

#### ✅ 智能预警系统
- **多级预警**：紧急、重要、一般三级预警
- **多渠道通知**：短信、APP推送、邮件通知
- **预警规则引擎**：支持自定义预警条件
- **历史趋势分析**：基于历史数据的预测预警

#### ✅ 设备生命周期管理
- **设备注册**：支持批量设备导入和注册
- **状态跟踪**：实时设备在线状态监控
- **维护提醒**：定期维护提醒和记录
- **故障诊断**：设备故障自动诊断和报告

---

## 六、总结与展望

### 6.1 技术架构总结

本系统采用现代化的微服务架构设计理念，通过Spring Boot多模块划分，实现了业务逻辑的清晰分离。MySQL数据库提供了稳定可靠的数据存储，结合Druid连接池和MyBatis框架，确保了数据访问的高性能和可维护性。Ollama AI的集成使得系统具备了智能化决策能力，为农业生产提供了科学的决策支持。

### 6.2 核心竞争优势

1. **本地化AI部署**：保护数据隐私，降低运营成本
2. **实时流式交互**：提供类ChatGPT的用户体验
3. **多维度环境监控**：全方位农业环境数据采集
4. **智能预警分析**：AI驱动的异常检测和预警
5. **模块化架构设计**：便于扩展和维护

### 6.3 未来发展方向

1. **边缘计算集成**：结合边缘设备，提升实时性
2. **多模态AI支持**：整合图像识别、语音识别能力
3. **区块链溯源**：农产品生产全过程可追溯
4. **5G+IoT融合**：利用5G网络，实现更广覆盖
5. **数字孪生技术**：构建虚拟农场，实现预测性维护

这套智能大棚环境监测系统通过MySQL实现可靠的数据持久化，结合Ollama AI提供智能农业咨询服务，形成了一个完整的智慧农业解决方案，为现代农业的数字化转型提供了强有力的技术支撑。